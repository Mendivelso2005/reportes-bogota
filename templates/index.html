<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mapa Ciudadano Bogotá</title>
  
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    
    /* Prevenir zoom en iOS cuando se hace tap en inputs */
    input, select, textarea {
      font-size: 16px;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes slideIn {
      from { transform: translateX(100%); }
      to { transform: translateX(0); }
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    .fade-in {
      animation: fadeIn 0.6s ease-out;
    }
    
    .slide-in {
      animation: slideIn 0.5s ease-out;
    }
    
    .marker-pulse {
      animation: pulse 2s infinite;
    }
    
    .glass-effect {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    .hover-lift {
      transition: all 0.3s ease;
    }
    
    @media (hover: hover) {
      .hover-lift:hover {
        transform: translateY(-5px);
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
      }
    }
    
    .gradient-border {
      position: relative;
      background: white;
      border-radius: 1rem;
    }
    
    .gradient-border::before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: 1rem;
      padding: 2px;
      background: linear-gradient(45deg, #14b8a6, #06b6d4, #3b82f6);
      -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
    }
    
    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .stat-card-2 {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }
    
    .stat-card-3 {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }
    
    /* Mobile optimizations */
    @media (max-width: 768px) {
      .slide-in {
        animation: fadeIn 0.6s ease-out;
      }
      
      .stat-card, .stat-card-2, .stat-card-3 {
        min-height: auto;
      }
    }
    
    /* Mejorar legibilidad en móviles */
    .line-clamp-3 {
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    /* ✅ FIX para permitir escribir en los inputs y textarea */
    .leaflet-container {
      z-index: 0 !important;
    }

    .gradient-border, .slide-in, form, input, textarea, select, button {
      position: relative;
      z-index: 10;
      pointer-events: auto !important;
    }

  </style>
</head>

<body class="bg-gradient-to-br from-gray-50 via-blue-50 to-teal-50 min-h-screen">
  
  <!-- HEADER MODERNO -->
  <header class="glass-effect shadow-xl sticky top-0 z-50">
    <div class="container mx-auto px-4 py-4">
      <div class="flex justify-between items-center">
        <div class="flex items-center space-x-4">
          <div class="bg-gradient-to-r from-teal-500 to-blue-500 p-3 rounded-2xl shadow-lg">
            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"></path>
            </svg>
          </div>
          <div>
            <h1 class="text-2xl font-bold bg-gradient-to-r from-teal-600 to-blue-600 bg-clip-text text-transparent">
              Mapa Ciudadano
            </h1>
            <p class="text-sm text-gray-600">Bogotá en tiempo real</p>
          </div>
        </div>
        
        <a href="/reportes" class="group relative px-6 py-3 bg-gradient-to-r from-teal-500 to-blue-500 text-white font-semibold rounded-xl overflow-hidden transition-all hover:shadow-xl hover:scale-105">
          <span class="relative z-10 flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
            </svg>
            Ver todos los reportes
          </span>
          <div class="absolute inset-0 bg-gradient-to-r from-blue-600 to-teal-600 opacity-0 group-hover:opacity-100 transition-opacity"></div>
        </a>
      </div>
    </div>
  </header>

  <!-- ESTADÍSTICAS RÁPIDAS -->
  <div class="container mx-auto px-4 py-6">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 fade-in">
      <div class="stat-card rounded-2xl p-6 text-white shadow-xl hover-lift">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-white/80 text-sm font-medium">Total Reportes</p>
            <p class="text-4xl font-bold mt-2">{{ reportes|length }}</p>
          </div>
          <div class="bg-white/20 p-4 rounded-full">
            <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
              <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
              <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
            </svg>
          </div>
        </div>
      </div>
      
      <div class="stat-card-2 rounded-2xl p-6 text-white shadow-xl hover-lift">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-white/80 text-sm font-medium">Hoy</p>
            <p class="text-4xl font-bold mt-2" id="reportesHoy">0</p>
          </div>
          <div class="bg-white/20 p-4 rounded-full">
            <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
            </svg>
          </div>
        </div>
      </div>
      
      <div class="stat-card-3 rounded-2xl p-6 text-white shadow-xl hover-lift">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-white/80 text-sm font-medium">En Proceso</p>
            <p class="text-4xl font-bold mt-2">{{ reportes|length }}</p>
          </div>
          <div class="bg-white/20 p-4 rounded-full">
            <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd"></path>
            </svg>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- CONTENEDOR PRINCIPAL -->
  <div class="container mx-auto px-4 pb-8">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      
      <!-- MAPA -->
      <div class="lg:col-span-2 fade-in">
        <div class="gradient-border shadow-2xl overflow-hidden">
          <div class="bg-gradient-to-r from-teal-500 to-blue-500 p-6 text-white">
            <div class="flex items-center gap-3">
              <div class="bg-white/20 p-3 rounded-xl">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
              </div>
              <div>
                <h2 class="text-xl font-bold">Selecciona la ubicación</h2>
                <p class="text-sm text-white/80">Haz clic en el mapa para marcar el problema</p>
              </div>
            </div>
          </div>
          <div id="map" class="h-[500px] lg:h-[600px]"></div>
        </div>
      </div>

      <!-- FORMULARIO FLOTANTE -->
      <div class="lg:col-span-1 slide-in">
        <div class="gradient-border shadow-2xl sticky top-24">
          <div class="p-8">
            <div class="text-center mb-6">
              <div class="inline-block bg-gradient-to-r from-teal-500 to-blue-500 p-4 rounded-2xl shadow-lg mb-4">
                <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"></path>
                </svg>
              </div>
              <h2 class="text-2xl font-bold bg-gradient-to-r from-teal-600 to-blue-600 bg-clip-text text-transparent">
                Reportar Problema
              </h2>
              <p class="text-sm text-gray-600 mt-2">Tu voz importa, ayuda a mejorar tu ciudad</p>
            </div>
            
            <form id="reporteForm" class="space-y-5">
              <!-- Imagen del reporte -->
              <div class="group">
                <label class="block text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
                  <span class="text-xl">📷</span>
                  Imagen (opcional)
                </label>
                <input type="file" id="imagen" name="imagen" accept="image/*" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-4 focus:ring-teal-100 focus:border-teal-500 transition-all bg-white text-gray-700 font-medium" />
              </div>
              
              <!-- Tipo de problema -->
              <div class="group">
                <label class="block text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
                  <span class="text-xl">🏷️</span>
                  Tipo de problema
                </label>
                <div class="relative">
                  <select id="tipo" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-4 focus:ring-teal-100 focus:border-teal-500 transition-all appearance-none bg-white text-gray-700 font-medium">
                    <option value="Basura">🗑️ Basura acumulada</option>
                    <option value="Huecos">🕳️ Huecos en la vía</option>
                    <option value="Luz">💡 Falta de alumbrado</option>
                    <option value="Ruido">🔊 Contaminación sonora</option>
                    <option value="Agua">💧 Fuga de agua</option>
                  </select>
                  <div class="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none">
                    <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                  </div>
                </div>
              </div>

              <!-- Nombre -->
              <div class="group">
                <label class="block text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
                  <span class="text-xl">👤</span>
                  Tu nombre
                </label>
                <input type="text" id="nombre" placeholder="Ej: María Gómez" 
                       class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-4 focus:ring-teal-100 focus:border-teal-500 transition-all font-medium">
              </div>

              <!-- Descripción -->
              <div class="group">
                <label class="block text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
                  <span class="text-xl">📝</span>
                  Descripción
                </label>
                <textarea id="descripcion" rows="4" placeholder="Describe lo que encontraste..."
                          class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-4 focus:ring-teal-100 focus:border-teal-500 transition-all resize-none font-medium"></textarea>
              </div>

              <!-- Ubicación seleccionada -->
              <div id="ubicacionInfo" class="hidden bg-gradient-to-r from-teal-50 to-blue-50 border-2 border-teal-200 rounded-xl p-4">
                <div class="flex items-start gap-3">
                  <div class="bg-teal-500 p-2 rounded-lg marker-pulse">
                    <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path>
                    </svg>
                  </div>
                  <div class="flex-1">
                    <p class="text-sm font-semibold text-teal-800">📍 Ubicación seleccionada</p>
                    <p id="coordenadas" class="text-xs text-teal-600 mt-1"></p>
                  </div>
                </div>
              </div>

              <!-- Botón -->
              <button type="submit" 
                      class="group relative w-full bg-gradient-to-r from-teal-500 to-blue-500 text-white py-4 rounded-xl font-bold text-lg overflow-hidden transition-all hover:shadow-2xl hover:scale-105">
                <span class="relative z-10 flex items-center justify-center gap-2">
                  <svg class="w-6 h-6 group-hover:rotate-12 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                  </svg>
                  Enviar Reporte
                </span>
                <div class="absolute inset-0 bg-gradient-to-r from-blue-600 to-teal-600 opacity-0 group-hover:opacity-100 transition-opacity"></div>
              </button>
            </form>
          </div>
        </div>
      </div>

    </div>

    <!-- REPORTES RECIENTES -->
    <div class="mt-8 fade-in">
      <div class="gradient-border shadow-2xl">
        <div class="p-8">
          <div class="flex items-center justify-between mb-6">
            <div class="flex items-center gap-3">
              <div class="bg-gradient-to-r from-teal-500 to-blue-500 p-3 rounded-xl">
                <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                  <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm9.707 5.707a1 1 0 00-1.414-1.414L9 12.586l-1.293-1.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                </svg>
              </div>
              <h2 class="text-2xl font-bold text-gray-800">Reportes Recientes</h2>
            </div>
            <span class="px-4 py-2 bg-gradient-to-r from-teal-100 to-blue-100 text-teal-700 rounded-full text-sm font-semibold">
              Últimos 6 reportes
            </span>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {% for reporte in reportes[:6] %}
            <div class="group relative bg-white border border-gray-200 rounded-2xl p-6 shadow-xl hover:shadow-2xl transition-all duration-300 hover:scale-[1.03] cursor-pointer" onclick='mostrarModal({{ reporte|tojson|safe }})'>
              <div class="absolute top-4 right-4">
                <button onclick="event.stopPropagation(); eliminarReporte({{ reporte.id }})" 
                        class="opacity-0 group-hover:opacity-100 bg-red-500 hover:bg-red-600 text-white p-2 rounded-lg transition-all">
                  <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                  </svg>
                </button>
              </div>

              {% if reporte.imagen %}
                <div class="flex justify-center mb-3">
                  <img src="/static/images/{{ reporte.imagen }}" alt="Imagen del reporte" class="rounded-xl shadow-lg max-w-[180px] max-h-[140px] object-cover border-2 border-teal-100" />
                </div>
              {% endif %}

              <div class="flex items-center gap-2 mb-4">
                <span class="px-3 py-1 rounded-full font-bold text-xs"
                  style="background: linear-gradient(90deg, #14b8a6 0%, #3b82f6 100%); color: white; box-shadow: 0 2px 8px #14b8a633;">
                  {{ reporte.tipo }}
                </span>
              </div>

              <p class="text-gray-700 text-base mb-4 line-clamp-3 font-medium">{{ reporte.descripcion }}</p>

              <div class="space-y-2 text-xs text-gray-500">
                <div class="flex items-center gap-2">
                  <span>👤</span>
                  <span class="font-semibold text-teal-700">{{ reporte.nombre }}</span>
                </div>
                <div class="flex items-center gap-2">
                  <span>🏢</span>
                  <span class="font-semibold">{{ reporte.entidad }}</span>
                </div>
                <div class="flex items-center gap-2">
                  <span>🕐</span>
                  <span>{{ reporte.fecha_creacion }}</span>
                </div>
              </div>
            </div>
  <!-- MODAL DE REPORTE -->
  <div id="modalReporte" class="fixed inset-0 bg-black/40 flex items-center justify-center z-[9999] hidden">
    <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-lg w-full relative animate-fadeIn border border-teal-100 flex flex-col items-center" style="box-shadow: 0 8px 32px #14b8a622;">
      <button onclick="cerrarModal()" class="absolute top-4 right-4 bg-teal-50 hover:bg-teal-100 rounded-full p-2 shadow transition-all">
        <svg class="w-6 h-6 text-teal-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
      </button>
      <div id="modalContenido" class="w-full"></div>
    </div>
  </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    function mostrarModal(reporte) {
      const modal = document.getElementById('modalReporte');
      const contenido = document.getElementById('modalContenido');
      let imgHtml = '';
      if (reporte.imagen) {
        imgHtml = `<img src='/static/images/${reporte.imagen}' alt='Imagen del reporte' class='mb-4 rounded-xl shadow-lg max-w-full max-h-60 mx-auto border-2 border-teal-100' />`;
      }
      contenido.innerHTML = `
        <div class='flex flex-col items-center'>
          ${imgHtml}
          <span class='px-4 py-1 rounded-full font-bold text-sm mb-3' style='background: linear-gradient(90deg, #14b8a6 0%, #3b82f6 100%); color: white; box-shadow: 0 2px 8px #14b8a633;'>${reporte.tipo}</span>
          <p class='text-gray-800 text-lg mb-3 font-semibold text-center'>${reporte.descripcion}</p>
          <div class='space-y-2 text-sm text-gray-500 text-center w-full'>
            <div class='flex items-center justify-center gap-2'><span>👤</span> <span class='font-semibold text-teal-700'>${reporte.nombre}</span></div>
            <div class='flex items-center justify-center gap-2'><span>🏢</span> <span class='font-semibold'>${reporte.entidad}</span></div>
            <div class='flex items-center justify-center gap-2'><span>🕐</span> ${reporte.fecha_creacion}</div>
          </div>
        </div>
      `;
      modal.classList.remove('hidden');
    }

    function cerrarModal() {
      document.getElementById('modalReporte').classList.add('hidden');
    }
    // Inicializar mapa
    const map = L.map('map').setView([4.711, -74.0721], 12);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    let marcadorTemporal = null;
    let ubicacionSeleccionada = null;

    const entidadPorTipo = {
      "Basura": "UAESP",
      "Huecos": "IDU",
      "Luz": "UAESP",
      "Ruido": "Secretaría de Ambiente",
      "Agua": "EAAB"
    };

    // Evento click en el mapa
    map.on('click', function(e) {
      if (marcadorTemporal) {
        map.removeLayer(marcadorTemporal);
      }
      
      marcadorTemporal = L.marker(e.latlng, {
        icon: L.icon({
          iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
          shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
          iconSize: [25, 41],
          iconAnchor: [12, 41],
          popupAnchor: [1, -34],
          shadowSize: [41, 41]
        })
      }).addTo(map).bindPopup("📍 Ubicación seleccionada").openPopup();
      
      ubicacionSeleccionada = e.latlng;
      
      // Mostrar info con animación
      const infoDiv = document.getElementById('ubicacionInfo');
      infoDiv.classList.remove('hidden');
      infoDiv.style.animation = 'fadeIn 0.5s ease-out';
      document.getElementById('coordenadas').textContent = 
        `Lat: ${e.latlng.lat.toFixed(5)}, Lng: ${e.latlng.lng.toFixed(5)}`;
    });

    // Cargar reportes existentes en el mapa
    const reportes = {{ reportes|tojson }};
    
    // Calcular reportes de hoy
    const hoy = new Date().toISOString().split('T')[0];
    const reportesHoy = reportes.filter(r => r.fecha_creacion.startsWith(hoy)).length;
    document.getElementById('reportesHoy').textContent = reportesHoy;
    
    reportes.forEach(r => {
      let imgHtml = '';
      if (r.imagen) {
        imgHtml = `<div class='flex justify-center mb-2'><img src='/static/images/${r.imagen}' alt='Imagen del reporte' class='rounded-xl shadow-lg max-w-[120px] max-h-[90px] object-cover border-2 border-teal-100' /></div>`;
      }
      const marker = L.marker([r.lat, r.lng]).addTo(map)
        .bindPopup(`
          <div class="bg-white rounded-2xl shadow-xl p-4 max-w-xs w-full border border-gray-200 animate-fadeIn">
            ${imgHtml}
            <div class="flex items-center gap-2 mb-2">
              <span class="px-2 py-1 rounded-full font-bold text-xs" style="background: linear-gradient(90deg, #14b8a6 0%, #3b82f6 100%); color: white; box-shadow: 0 2px 8px #14b8a633;">${r.tipo}</span>
            </div>
            <div class="text-gray-700 text-sm mb-2 font-medium text-center">${r.descripcion}</div>
            <div class="space-y-1 text-xs text-gray-500 text-center">
              <div><span>👤</span> <span class="font-semibold text-teal-700">${r.nombre}</span></div>
              <div><span>🏢</span> <span class="font-semibold">${r.entidad}</span></div>
              <div><span>🕐</span> ${r.fecha_creacion}</div>
            </div>
          </div>
        `);
    });

    // Enviar reporte
    document.getElementById('reporteForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      const tipo = document.getElementById('tipo').value;
      const nombre = document.getElementById('nombre').value;
      const descripcion = document.getElementById('descripcion').value;
      const imagenInput = document.getElementById('imagen');
      const imagen = imagenInput.files[0];

      if (!ubicacionSeleccionada) {
        alert('⚠️ Por favor, selecciona una ubicación en el mapa');
        return;
      }
      if (!nombre.trim()) {
        alert('⚠️ Por favor, ingresa tu nombre');
        return;
      }
      if (!descripcion.trim()) {
        alert('⚠️ Por favor, describe el problema');
        return;
      }

      const formData = new FormData();
      formData.append('tipo', tipo);
      formData.append('nombre', nombre);
      formData.append('descripcion', descripcion);
      formData.append('lat', ubicacionSeleccionada.lat);
      formData.append('lng', ubicacionSeleccionada.lng);
      formData.append('entidad', entidadPorTipo[tipo]);
      if (imagen) {
        formData.append('imagen', imagen);
      }

      try {
        const res = await fetch('/reporte', {
          method: 'POST',
          body: formData
        });
        if (res.ok) {
          alert('✅ Reporte agregado correctamente');
          location.reload();
        } else {
          const error = await res.json();
          alert('❌ Error: ' + error.error);
        }
      } catch (error) {
        alert('❌ Error al enviar el reporte');
        console.error(error);
      }
    });

    // Eliminar reporte
    async function eliminarReporte(id) {
      if (!confirm('¿Seguro que quieres eliminar este reporte?')) {
        return;
      }

      try {
        const res = await fetch(`/eliminar/${id}`, { method: 'DELETE' });
        if (res.ok) {
          alert('✅ Reporte eliminado');
          location.reload();
        }
      } catch (error) {
        alert('❌ Error al eliminar');
        console.error(error);
      }
    }
  </script>

</body>
</html>